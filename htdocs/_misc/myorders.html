<?php

include_once('base.inc.php');

$P = array(
    'base' => array(
        'cb_pagetype' => 'content',
        'cb_pageconfig' => '',
        'cb_subnav' => '',
    ),
    'lang' => array(
        'cl_lang' => $sLang,
        'cl_html' => '',
    ),
);

include_once('shop/functions.shoppingcart.inc.php');

$sH = '';

if (isset($_SESSION["user"]) && is_array($_SESSION["user"])) {
    $P["base"]["cb_customcontenttemplate"] = 'shop/myorders';

    if (isset($_GET["action"]) && $_GET["action"] == 'show' && isset($_GET["id"])) {
        $iId = \HaaseIT\Tools::cED($_GET["id"]);

        $sQ = "SELECT * FROM ".DB_ORDERTABLE." WHERE o_id = :id AND o_custno = '".$_SESSION["user"]["cust_no"]."' AND o_ordercompleted != 'd'";
        $hResult = $DB->prepare($sQ);
        $hResult->bindValue(':id', $iId);
        $hResult->execute();

        if ($hResult->rowCount() == 1) {
            $aOrder = $hResult->fetch();
            $sH .= '<h1>'.T("myorders_headline").' '.date($C["locale_format_date_time"], $aOrder["o_ordertimestamp"]).':</h1><br>';
            if (trim($aOrder["o_remarks"]) !='') $sH .= '<strong>'.T("myorders_remarks").'</strong><br>'.$aOrder["o_remarks"].'<br><br>';
            $sH .= '<strong>Zahlungsmethode:</strong> '.T("order_paymentmethod_".$aOrder["o_paymentmethod"]).'<br>';
            $sH .= '<strong>'.T("myorders_paymentstatus").'</strong> '.(($aOrder["o_paymentcompleted"] == 'y') ? T("myorders_paymentstatus_completed") : T("myorders_paymentstatus_open")).'<br>';
            $sH .= '<strong>'.T("myorders_orderstatus").'</strong> '.showOrderStatusText($aOrder["o_ordercompleted"]).'<br>';
            if (trim($aOrder["o_shipping_service"]) !='') $sH .= '<strong>'.T("myorders_shipping_service").'</strong> '.$aOrder["o_shipping_service"].'<br>';
            if (trim($aOrder["o_shipping_trackingno"]) !='') $sH .= '<strong>'.T("myorders_shipping_trackingno").'</strong> '.$aOrder["o_shipping_trackingno"].'<br>';
            $sH .= '<br>';

            $sQ = "SELECT * FROM ".DB_ORDERTABLE_ITEMS." WHERE oi_o_id = :id";
            $hResult = $DB->prepare($sQ);
            $hResult->bindValue(':id', $iId);
            $hResult->execute();
            //debug($DB->numRows($hResult));

            $aItems = $hResult->fetchAll();

            foreach ($aItems as $aValue) {
                $aPrice = array(
                    'netto_use' => $aValue["oi_price_netto_use"],
                    'brutto_use' => $aValue["oi_price_brutto_use"],
                );
                $aItemsforShoppingcarttable[$aValue["oi_cartkey"]] = array(
                    'amount' => $aValue["oi_amount"],
                    'price' => $aPrice,
                    'vat' => $C["vat"][$aValue["oi_vat_id"]],
                    //'rg' => $aValue["oi_rg"],
                    'name' => $aValue["oi_itemname"],
                    'img' => $aValue["oi_img"],
                );
            }

            $aShoppingcart = buildShoppingCartTable($aItemsforShoppingcarttable, true);
        }

        else $sH .= T("myorders_order_not_found");

    } else {
        $COList = array(
            array('title' => T("order_head_orderdate"), 'key' => 'o_ordertime', 'width' => 110, 'linked' => false,),
            array('title' => T("order_head_paymenthethod"), 'key' => 'o_paymentmethod', 'width' => 125, 'linked' => false,),
            array('title' => T("order_head_paid"), 'key' => 'o_paymentcompleted', 'width' => 60, 'linked' => false,),
            array('title' => T("order_head_status"), 'key' => 'o_order_status', 'width' => 80, 'linked' => false,),
            array('title' => T("order_head_shipping_service"), 'key' => 'o_shipping_service', 'width' => 90, 'linked' => false,),
            array('title' => T("order_head_shipping_trackingno"), 'key' => 'o_shipping_trackingno', 'width' => 130, 'linked' => false,),
            array(
                'title' => T("order_show"),
                'key' => 'o_id',
                'width' => 120,
                'linked' => true,
                'ltarget' => $_SERVER["PHP_SELF"],
                'lkeyname' => 'id',
                'lgetvars' => array('action' => 'show',),
            ),
        );

        $sH .= showMyOrders($COList, $twig);
    }

} else {
    $sH .= T("denied_notloggedin");
}

//if (clientIsLocal()) debug($_SERVER);

$P["lang"]["cl_html"] = $sH;
if (isset($aShoppingcart)) {
    $P["base"]["cb_customdata"] = $aShoppingcart;
}

$aP = generatePage($C, $P, $sLang);

echo $twig->render($C["template_base"], $aP);